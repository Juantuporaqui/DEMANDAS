// ============================================
// CASE OPS - PDF Viewer
// ============================================

import { useState, useEffect, useRef, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
// CORRECCIÓN: Importación directa
import { Modal } from '../../components/Modal';
import { documentsRepo, docFilesRepo } from '../../db/repositories';
import type { Document } from '../../types';
import * as pdfjsLib from 'pdfjs-dist';
import './PdfViewer.css';

// CORRECCIÓN IMPORTANTE: Configurar el Worker para que no falle el build/runtime
pdfjsLib.GlobalWorkerOptions.workerSrc = new URL(
  'pdfjs-dist/build/pdf.worker.min.mjs',
  import.meta.url
).toString();

export function PdfViewerPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const canvasRef = useRef<HTMLCanvasElement>(null);

  const [document, setDocument] = useState<Document | null>(null);
  const [pdfDoc, setPdfDoc] = useState<pdfjsLib.PDFDocumentProxy | null>(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [numPages, setNumPages] = useState(0);
  const [scale, setScale] = useState(1.0);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (id) loadDocument(id);
  }, [id]);

  useEffect(() => {
    if (pdfDoc) renderPage(currentPage);
  }, [pdfDoc, currentPage, scale]);

  async function loadDocument(docId: string) {
    try {
      setLoading(true);
      const doc = await documentsRepo.getById(docId);
      if (!doc) {
        alert('Documento no encontrado');
        navigate('/documents');
        return;
      }
      setDocument(doc);

      const file = await docFilesRepo.getById(doc.fileId);
      if (!file) {
        alert('Archivo PDF físico no encontrado');
        return;
      }

      const arrayBuffer = await file.blob.arrayBuffer();
      const loadedPdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      setPdfDoc(loadedPdf);
      setNumPages(loadedPdf.numPages);
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  const renderPage = useCallback(async (pageNum: number) => {
    if (!pdfDoc || !canvasRef.current) return;
    
    try {
      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale });
      const canvas = canvasRef.current;
      const context = canvas.getContext('2d');

      if (context) {
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: context, viewport }).promise;
      }
    } catch (err) {
      console.error('Error renderizando página', err);
    }
  }, [pdfDoc, scale]);

  if (loading) return <div className="p-8 text-center text-white">Cargando PDF...</div>;

  return (
    <div className="pdf-viewer">
      <div className="pdf-header">
        <button onClick={() => navigate(-1)} className="text-slate-400 hover:text-white">← Volver</button>
        <div className="pdf-title">{document?.title}</div>
        <div className="flex gap-2">
           <button onClick={() => setScale(s => Math.max(0.5, s - 0.2))} className="px-2 bg-slate-700 rounded">-</button>
           <span>{Math.round(scale * 100)}%</span>
           <button onClick={() => setScale(s => Math.min(3, s + 0.2))} className="px-2 bg-slate-700 rounded">+</button>
        </div>
      </div>

      <div className="pdf-canvas-container">
        <canvas ref={canvasRef} className="pdf-canvas" />
      </div>

      <div className="pdf-nav">
        <button 
          onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
          disabled={currentPage <= 1}
          className="px-3 py-1 bg-slate-700 rounded disabled:opacity-50"
        >
          Anterior
        </button>
        <span className="text-sm">
          Página <input 
            type="number" 
            value={currentPage} 
            onChange={(e) => setCurrentPage(Number(e.target.value))}
            className="pdf-page-input mx-1"
          /> de {numPages}
        </span>
        <button 
          onClick={() => setCurrentPage(p => Math.min(numPages, p + 1))}
          disabled={currentPage >= numPages}
          className="px-3 py-1 bg-slate-700 rounded disabled:opacity-50"
        >
          Siguiente
        </button>
      </div>
    </div>
  );
}
